apiVersion: apps/v1
kind: Deployment
metadata:
  name: kbk-deployment
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: kbk
  template:
    metadata:
      labels:
        app: kbk
    spec:
      volumes:
        - name: kbk-player-storage
          persistentVolumeClaim:
            claimName: kbk-player-pvc
        - name: kbk-sys-storage
          persistentVolumeClaim:
            claimName: kbk-sys-pvc
        - name: kbk-area-storage
          persistentVolumeClaim:
            claimName: kbk-area-pvc
        - name: kbk-files
          emptyDir: {}
      initContainers:
        - name: init-kbk-data
          image: bubthegreat/kbk:3a3234a
          command: ['sh', '-c']
          args:
            - |
              # Copy player files if volume is empty
              if [ ! -f /kbk-persistent/player/Player.lst ]; then
                echo "Initializing player directory..."
                cp -r /kbk/player/* /kbk-persistent/player/ || true
              fi
              # Copy sys files if volume is empty
              if [ ! -f /kbk-persistent/sys/bugs.txt ]; then
                echo "Initializing sys directory..."
                cp -r /kbk/sys/* /kbk-persistent/sys/ || true
              fi
              # Copy area files if volume is empty (includes the compiled binary)
              if [ ! -f /kbk-persistent/area/area.lst ]; then
                echo "Initializing area directory..."
                cp -r /kbk/area/* /kbk-persistent/area/ || true
              fi
              echo "Initialization complete!"
          volumeMounts:
            - name: kbk-player-storage
              mountPath: /kbk-persistent/player
            - name: kbk-sys-storage
              mountPath: /kbk-persistent/sys
            - name: kbk-area-storage
              mountPath: /kbk-persistent/area
      containers:
        - name: kbk
          image: bubthegreat/kbk:3a3234a
          imagePullPolicy: Always
          ports:
            - containerPort: 8989
          volumeMounts:
            - name: kbk-player-storage
              mountPath: /kbk/player
            - name: kbk-sys-storage
              mountPath: /kbk/sys
            - name: kbk-area-storage
              mountPath: /kbk/area
            - name: kbk-files
              mountPath: /kbk/localxfer

