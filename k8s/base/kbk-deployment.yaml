apiVersion: apps/v1
kind: Deployment
metadata:
  name: kbk-deployment
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: kbk
  template:
    metadata:
      labels:
        app: kbk
    spec:
      # Reduce termination grace period for faster shutdowns
      terminationGracePeriodSeconds: 5
      volumes:
        - name: kbk-player-storage
          persistentVolumeClaim:
            claimName: kbk-player-pvc
        - name: kbk-sys-storage
          persistentVolumeClaim:
            claimName: kbk-sys-pvc
        - name: kbk-data-storage
          persistentVolumeClaim:
            claimName: kbk-data-pvc
        - name: kbk-files
          emptyDir: {}
      initContainers:
        - name: init-kbk-data
          image: bubthegreat/kbk:d860630
          command: ['sh', '-c']
          args:
            - |
              # Copy player files if volume is empty
              if [ ! -f /kbk-persistent/player/Player.lst ]; then
                echo "Initializing player directory..."
                cp -r /kbk/player/* /kbk-persistent/player/ || true
              else
                echo "Player directory already initialized, skipping..."
              fi
              # Copy sys files if volume is empty
              if [ ! -f /kbk-persistent/sys/bugs.txt ]; then
                echo "Initializing sys directory..."
                cp -r /kbk/sys/* /kbk-persistent/sys/ || true
              else
                echo "Sys directory already initialized, skipping..."
              fi
              # Initialize SQLite database if it doesn't exist
              if [ ! -f /kbk-persistent/data/kbk.db ]; then
                echo "Initializing SQLite database..."
                mkdir -p /kbk-persistent/data
                sqlite3 /kbk-persistent/data/kbk.db < /kbk/data/init_sqlite.sql
                echo "SQLite database initialized"
              else
                echo "SQLite database already exists, skipping..."
              fi
              echo "Initialization complete!"
          volumeMounts:
            - name: kbk-player-storage
              mountPath: /kbk-persistent/player
            - name: kbk-sys-storage
              mountPath: /kbk-persistent/sys
            - name: kbk-data-storage
              mountPath: /kbk-persistent/data
      containers:
        - name: kbk
          image: bubthegreat/kbk:d860630
          imagePullPolicy: Always
          env:
            - name: ENABLE_GDB_DEBUGGING
              valueFrom:
                configMapKeyRef:
                  name: kbk-config
                  key: ENABLE_GDB_DEBUGGING
          ports:
            - containerPort: 8989
              name: telnet
          # Add readiness probe to know when app is ready
          readinessProbe:
            tcpSocket:
              port: 8989
            initialDelaySeconds: 5
            periodSeconds: 2
            timeoutSeconds: 1
            successThreshold: 1
            failureThreshold: 3
          # Add liveness probe to detect if app is hung
          livenessProbe:
            tcpSocket:
              port: 8989
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 1
            successThreshold: 1
            failureThreshold: 3
          # Add startup probe for initial startup (more lenient)
          startupProbe:
            tcpSocket:
              port: 8989
            initialDelaySeconds: 0
            periodSeconds: 2
            timeoutSeconds: 1
            successThreshold: 1
            failureThreshold: 30
          volumeMounts:
            - name: kbk-player-storage
              mountPath: /kbk/player
            - name: kbk-sys-storage
              mountPath: /kbk/sys
            - name: kbk-data-storage
              mountPath: /kbk/data
            - name: kbk-files
              mountPath: /kbk/localxfer

